version: '3.7'
services:

#   mongodb:
#     image: mongo
#     restart: always
#     networks:
#       - server
#     ports:
#       - 27017:27017 # unsecure port, might not be needed as secure port 2096 is accessible
#     environment:
#       MONGO_INITDB_ROOT_USERNAME: user
#       MONGO_INITDB_ROOT_PASSWORD: pass
#     volumes:
#       - ./mongo-volume:/data/db
#       - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo-js:ro
#     labels:
#       - traefik.enable=true
#       - traefik.backend=mongodb
#       - traefik.tcp.routers.mongodb.rule=HostSNI(`url.for.db.domain`)
#       - traefik.docker.network=server
#       - traefik.tcp.routers.mongodb.entrypoints=mongo #mongo
#       - traefik.tcp.routers.mongodb.service=mongodb
#       - traefik.tcp.services.mongodb.loadbalancer.server.port=27017
#     container_name: mongodb
  iiidentex_mongodb_test:
    image: mongo
    restart: always
    networks:
      - server
    # ports:
    #  - 10217:27017 # local access
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${DB_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${DB_PASSWORD}
    volumes:
      - ./mongo-volume:/data/db
      - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo-js:ro
    container_name: iiidentex_mongodb_test
  
  iiidentex_backend:
    # build: .
    # depends_on:
    #   - mongodb
    image: iiidentex/backend
    restart: always
    depends_on:
      - iiidentex_mongodb_test
    environment:
        # ATLAS_URI: mongodb+srv://sudo:sudo@cluster0.konox.mongodb.net/iiidentex-db?retryWrites=true&w=majority
        # JSONWTK: h98asblj23hfjka
        ATLAS_URI: mongodb://${DB_USERNAME}:${DB_PASSWORD}@iiidentex_mongodb_test:27017/db?authSource=admin&readPreference=primary
        JSONWTK: ${JSONWTK}
    networks:
      - server
    #ports:
    #  - 5000:5000
    labels:
      - traefik.enable=true
      - traefik.docker.network=server

      - traefik.http.services.iiidentex_backend.loadbalancer.server.port=5000
      - traefik.http.routers.iiidentex_backend.service=iiidentex_backend
      # - traefik.http.routers.iiidentex_backend.rule=Host(`vexsdev.fsktm.um.edu.my`) && PathPrefix(`/iiidentex_uitm`)
      # - traefik.http.routers.iiidentex_backend.entrypoints=https
      # - traefik.http.routers.iiidentex_backend.tls.certresolver=mytlschallenge
      ### Not Secure ###
      # - traefik.http.routers.iiidentex_backend-unsecured.service=iiidentex_backend
      # - traefik.http.routers.iiidentex_backend-unsecured.rule=Host(`vexsdev.fsktm.um.edu.my`) && PathPrefix(`/api/`)
      - traefik.http.routers.iiidentex_backend.rule=Host(`vexsdev.fsktm.um.edu.my`) && PathPrefix(`/iiidentex_uitm`)
      - traefik.http.routers.iiidentex_backend.entrypoints=http
      # - traefik.http.routers.iiidentex_backend-unsecured.middlewares=redirect@file # uncomment to enable ssl when 443 is ready
    container_name: iiidentex_backend

networks:
  server:
    external: true